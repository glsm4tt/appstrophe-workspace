# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install
        run: npm ci --legacy-peer-deps && npm --prefix functions ci && sudo npm install -g firebase-tools
      - name: Setting environment
        run: |
          firebase use appstrophe-a65a0 --token ${{ secrets.FIREBASE_TOKEN }}
          sed -i 's/__API_KEY__/${{ secrets.API_KEY_PROD }}/g' apps/auth/src/environments/environment.prod.ts
          sed -i 's/__AUTH_DOMAIN__/${{ secrets.AUTH_DOMAIN_PROD }}/g' apps/auth/src/environments/environment.prod.ts
          sed -i 's/__PROJECT_ID__/${{ secrets.PROJECT_ID_PROD }}/g' apps/auth/src/environments/environment.prod.ts
          sed -i 's/__STORAGE_BUCKET__/${{ secrets.STORAGE_BUCKET_PROD }}/g' apps/auth/src/environments/environment.prod.ts
          sed -i 's/__MASSAGING_SENDER_ID__/${{ secrets.MASSAGING_SENDER_ID_PROD }}/g' apps/auth/src/environments/environment.prod.ts
          sed -i 's/__APP_ID__/${{ secrets.APP_ID_PROD }}/g' apps/auth/src/environments/environment.prod.ts
          sed -i 's/__MEASUREMENT_ID__/${{ secrets.MEASUREMENT_ID_PROD }}/g' apps/auth/src/environments/environment.prod.ts
          sed -i 's/__API_KEY__/${{ secrets.API_KEY_PROD }}/g' apps/blog/src/environments/environment.prod.ts
          sed -i 's/__AUTH_DOMAIN__/${{ secrets.AUTH_DOMAIN_PROD }}/g' apps/blog/src/environments/environment.prod.ts
          sed -i 's/__PROJECT_ID__/${{ secrets.PROJECT_ID_PROD }}/g' apps/blog/src/environments/environment.prod.ts
          sed -i 's/__STORAGE_BUCKET__/${{ secrets.STORAGE_BUCKET_PROD }}/g' apps/blog/src/environments/environment.prod.ts
          sed -i 's/__MASSAGING_SENDER_ID__/${{ secrets.MASSAGING_SENDER_ID_PROD }}/g' apps/blog/src/environments/environment.prod.ts
          sed -i 's/__APP_ID__/${{ secrets.APP_ID_PROD }}/g' apps/blog/src/environments/environment.prod.ts
          sed -i 's/__MEASUREMENT_ID__/${{ secrets.MEASUREMENT_ID_PROD }}/g' apps/blog/src/environments/environment.prod.ts
          sed -i 's/__API_KEY__/${{ secrets.API_KEY_PROD }}/g' apps/shell/src/environments/environment.prod.ts
          sed -i 's/__AUTH_DOMAIN__/${{ secrets.AUTH_DOMAIN_PROD }}/g' apps/shell/src/environments/environment.prod.ts
          sed -i 's/__PROJECT_ID__/${{ secrets.PROJECT_ID_PROD }}/g' apps/shell/src/environments/environment.prod.ts
          sed -i 's/__STORAGE_BUCKET__/${{ secrets.STORAGE_BUCKET_PROD }}/g' apps/shell/src/environments/environment.prod.ts
          sed -i 's/__MASSAGING_SENDER_ID__/${{ secrets.MASSAGING_SENDER_ID_PROD }}/g' apps/shell/src/environments/environment.prod.ts
          sed -i 's/__APP_ID__/${{ secrets.APP_ID_PROD }}/g' apps/shell/src/environments/environment.prod.ts
          sed -i 's/__MEASUREMENT_ID__/${{ secrets.MEASUREMENT_ID_PROD }}/g' apps/shell/src/environments/environment.prod.ts
          sed -i 's_http://localhost:4201_https://appstrophe-auth-f3e74.web.app_g' firebase.json
          sed -i 's_http://localhost:4202_https://appstrophe-blog-46f62.web.app_g' firebase.json 
          sed -i 's/appstrophe-test-auth.web.app/appstrophe-auth-f3e74.web.app/g' apps/shell/src/environments/environment.prod.ts
          sed -i 's/appstrophe-test-blog.web.app/appstrophe-blog-46f62.web.app/g' apps/shell/src/environments/environment.prod.ts 
      - name: Setting config
        uses: jsdaniell/create-json@1.1.2
        with:
          name: "functions/firebase.config.json"
          json: ${{ secrets.FIREBASE_CONFIG_PROD }}
      - name: Setting account key
        uses: jsdaniell/create-json@1.1.2
        with:
          name: "functions/serviceAccountKey.json"
          json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY_PROD }}
      - name: Build
        run: npx nx run-many --target=build --all && npm --prefix functions run build
      - name: Deployment
        run: firebase deploy --token ${{ secrets.FIREBASE_TOKEN }} 
